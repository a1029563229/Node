# 玩转进程

## 服务模型的变迁
+ 同步；
+ 复制进程；
+ 多线程；
+ 事件驱动；

## 多进程架构
+ Master-Worker 模式，又称主从模式。主进程不负责具体的业务处理，而是负责调度或管理工作进程，它是趋向于稳定的。工作进程负责具体的业务处理。（集群模式）

### 创建子进程
+ child_process 模块
  + spawn()：启动一个子进程来执行命令；
  + exec()：启动一个子进程来执行命令，它有一个回调函数来获知子进程的情况；
  + execFile()：启动一个子进程来执行可执行文件；
  + fork()：与 span() 类似，不同点在于它创建 Node 的子进程只需指定要执行的 Javascript 文件模块即可；
+ 创建子进程后，父进程与子进程之间将会创建 IPC 通道。通过 IPC 通道，父子进程之间使用 send() 和 message 传递消息；
+ IPC 的全称是 Inter-Process Communication，进程间通信。在 Node 中，父进程在实际创建子进程之前，会创建 IPC 通道并监听它，然后才真正创建出子进程，并通过环境变量（NODE_CHANNEL_FD）告诉子进程这个 IPC 通道的文件描述符。子进程在启动的过程中，根据文件描述符去连接这个已存在的 IPC 通道，从而完成父子进程之间的连接。建立连接之后的父子进程就可以自由地通信了。
+ 句柄发送：message 对象被传递进 IPC 管道之前被转化为字符串，从管道中取出后会被还原为对象。
+ 使用 child_process 模块再单机上搭建 Node 集群是件相对容易的事情，同时也可以充分利用 CPU 资源。

## 集群稳定之路
+ 需要考虑的问题
  + 性能问题；
  + 多个工作进程的存活状态管理；
  + 工作进程的平滑重启；
  + 配置或者静态数据的动态重新载入；
+ 进程事件
  + error：当子进程无法被复制创建、无法被杀死、无法发送消息时会触发该事件；
  + exit：子进程退出时触发该事件；
  + close：在子进程的标准输入输出流中止时触发该事件；
  + disconnect：在父进程或子进程中调用 disconnect() 方法时触发该事件，在调用该方法时将关闭监听 IPC 通道；
+ 自动重启：通过监听子进程的 exit 事件来完成自动重启；
+ 负载均衡：Node 中提供了一种 Round-Robin 机制，又称轮叫调度。轮叫调度的工作方式是主进程接收连接，将其依次分发给工作进程。分发的策略是在 N 个工作进程中，每次选择 i = (i + 1) mod n 个进程来发送连接。